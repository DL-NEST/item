"use strict";var P=Object.defineProperty;var h=Object.getOwnPropertySymbols;var A=Object.prototype.hasOwnProperty,v=Object.prototype.propertyIsEnumerable;var g=(t,e,o)=>e in t?P(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o,d=(t,e)=>{for(var o in e||(e={}))A.call(e,o)&&g(t,o,e[o]);if(h)for(var o of h(e))v.call(e,o)&&g(t,o,e[o]);return t};var s=require("electron"),a=require("path"),_=require("child_process"),L=require("os"),y=require("url"),k=require("fs");function T(t){if(t&&t.__esModule)return t;var e=Object.create(null,{[Symbol.toStringTag]:{value:"Module"}});return t&&Object.keys(t).forEach(function(o){if(o!=="default"){var r=Object.getOwnPropertyDescriptor(t,o);Object.defineProperty(e,o,r.get?r:{enumerable:!0,get:function(){return t[o]}})}}),e.default=t,Object.freeze(e)}var f=T(a);function x(t){t.createElectronProcess("taskManager","/taskManager",{width:600,height:500,title:"\u4EFB\u52A1\u7BA1\u7406\u5668",icon:a.join(__dirname,"../../public/favicon.png"),autoHideMenuBar:!0,alwaysOnTop:!0,webPreferences:{contextIsolation:!1,nodeIntegration:!0,preload:a.join(__dirname,"../preload/index.cjs")}},()=>{s.ipcMain.on("btn_switch",(e,o)=>{o==="closeAll"&&t.exitAllTaskProcess()})})}function w(t){t.createElectronProcess("main","/",{width:1055,height:710,icon:a.join(__dirname,"../../public/favicon.png"),frame:!1,titleBarStyle:"hidden",webPreferences:{contextIsolation:!1,nodeIntegration:!0,webSecurity:!0,webgl:!0,preload:a.join(__dirname,"../preload/index.cjs")}},()=>{})}function E(){s.protocol.registerSchemesAsPrivileged([{scheme:"app",privileges:{secure:!0,standard:!0}}])}const F=(t,e)=>{(e||s.protocol).registerBufferProtocol(t,(o,r)=>{let i=new y.URL(o.url).pathname;i=decodeURI(i),k.readFile(f.join(__dirname,"..",i),(n,p)=>{n&&(console.error(`Failed to read ${i} on ${t} protocol`,n),m({title:"url",body:`Failed to read ${f.join(__dirname,i)} on ${t} protocol`}));const l=f.extname(i).toLowerCase();let c="";l===".js"?c="text/javascript":l===".html"?c="text/html":l===".css"?c="text/css":l===".svg"||l===".svgz"?c="image/svg+xml":l===".json"?c="application/json":l===".wasm"&&(c="application/wasm"),r({mimeType:c,data:p})})})};function B(t,e){e=new s.Tray(a.join(__dirname,"../../public/favicon.png"));const o=s.Menu.buildFromTemplate([{label:"\u5173\u4E8E\u9879\u76EE",type:"normal",click:()=>{s.shell.openExternal("https://github.com/DL-NEST").then(r=>{})}},{label:"\u68C0\u6D4B\u66F4\u65B0",type:"normal",click:()=>{m({title:"\u68C0\u6D4B\u66F4\u65B0",body:"\u6CA1\u6709\u66F4\u65B0"})}},{label:"Item2",type:"separator",click:()=>{}},{label:"\u91CD\u65B0\u52A0\u8F7D",type:"normal",click:()=>{t.getMainElectron().reload()}},{label:"\u9000\u51FA",type:"normal",click:()=>{t.exitAllTaskProcess()}}]);e.setToolTip(`item
\u7248\u672C\u53F7\uFF1A0.1.0
\u4F5C\u8005\uFF1Adl-nest`),e.setContextMenu(o),e.on("click",()=>{t.getMainElectron().show()})}function m(t){new s.Notification(d({icon:a.join(__dirname,"../../public/favicon.png")},t)).show()}function j(){S()}function S(){s.ipcMain.on("btn_switch",(t,e)=>{let o=s.BrowserWindow.getFocusedWindow();switch(e){case"minimize":o.minimize();break;case"close":o.close();break;case"maximize":o.isMaximized()?o.unmaximize():o.maximize();break;case"fix":o.setAlwaysOnTop(!o.isAlwaysOnTop(),"floating");break}})}function M(){L.release().startsWith("6.1")&&s.app.disableHardwareAcceleration(),process.platform==="win32"&&s.app.setAppUserModelId(s.app.getName()),process.env.ELECTRON_DISABLE_SECURITY_WARNINGS="true",E()}class C{constructor(){this.electronProcessList={},this.taskProcessList={}}getTaskProcessList(){return this.taskProcessList}getElectronProcessList(){return this.electronProcessList}getTaskProcessByName(e){return this.taskProcessList[e]}getElectronProcessByName(e){return this.electronProcessList[e]}getMainElectron(){return this.electronProcessList.main}exitAllTaskProcess(){for(let e in this.taskProcessList)this.taskProcessList[e].kill();for(let e in this.electronProcessList)this.electronProcessList[e].close()}createElectronProcess(e,o,r,i){if(this.electronProcessList[e])return;const n=new s.BrowserWindow(d({show:!1},r));F("app"),s.app.isPackaged?n.loadURL(`app://../render/index.html#${o}`).then(p=>{}):n.loadURL(`http://localhost:3000/#${o}`).then(p=>{}),this.electronProcessList[e]=n,n.on("close",()=>{console.log(`${e} -- close`),delete this.electronProcessList[e]}),n.on("ready-to-show",()=>{n.show()}),i()}createTaskProcess(e,o,r){this.taskProcessList[e]||(this.taskProcessList[e]=_.spawn(o,r),this.taskProcessList[e].on("exit",i=>{console.log(`\u4EFB\u52A1\u8FDB\u7A0B ${e} \u9000\u51FA,\u9000\u51FA\u7801\u4E3A: ${i}`),delete this.taskProcessList[e]}))}}let u=new C,b=null;M();s.app.whenReady().then(async()=>{await w(u),I(u),j(),B(u,b)});s.app.on("activate",()=>{s.BrowserWindow.getAllWindows().length===0&&w(u)});s.app.on("ready",()=>{});s.app.on("window-all-closed",()=>{process.platform!=="darwin"&&s.app.quit()});s.app.on("will-quit",()=>{s.globalShortcut.unregisterAll(),b.destroy()});function I(t){s.globalShortcut.isRegistered("Alt+q")&&console.log("have registered");let e=t.getMainElectron();s.globalShortcut.register("Alt+q",()=>{e.isFocused()?(e.minimize(),e.reload()):e.focus()}),s.globalShortcut.register("Alt+w",()=>{e.webContents.isDevToolsOpened()?e.webContents.closeDevTools():e.webContents.openDevTools({mode:"undocked"})}),s.globalShortcut.register("Alt+e",()=>{x(t)})}
